// éŸ³å£°èªè­˜ã®è¨­å®š
let recognition;
let isRecording = false;

// DOMè¦ç´ ã®å–å¾—
const recordBtn = document.getElementById("recordBtn");
const status = document.getElementById("status");
const transcript = document.getElementById("transcript");
const feedback = document.getElementById("feedback");
const support = document.getElementById("support");
const history = document.getElementById("history");
const clearBtn = document.getElementById("clearBtn");

// éŸ³å£°èªè­˜åˆæœŸåŒ–ï¼ˆè‹±èªè¨­å®šï¼‰
function initSpeechRecognition() {
  if ("webkitSpeechRecognition" in window || "SpeechRecognition" in window) {
    const SpeechRecognition =
      window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();

    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = "en-US"; // è‹±èªè¨­å®š
    recognition.maxAlternatives = 1;

    recognition.onstart = function () {
      isRecording = true;
      recordBtn.textContent = "ğŸ”´ èã„ã¦ã„ã‚‹ã‚ˆ...";
      recordBtn.classList.add("recording");
      status.textContent = "è‹±èªã§è©±ã—ã¦ã¿ã¦ï¼ï¼ˆ30ç§’ä»¥å†…ï¼‰";

      // 30ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
      setTimeout(() => {
        if (isRecording) {
          recognition.stop();
        }
      }, 30000);
    };

    recognition.onresult = async function (event) {
      const result = event.results[0][0].transcript;
      const confidence = event.results[0][0].confidence;

      // çµæœè¡¨ç¤º
      transcript.textContent = result;

      // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”Ÿæˆ
      // AIæ©Ÿèƒ½ã‚’ä½¿ç”¨
      await showFeedbackWithAI(result);

      // æ—¥æœ¬èªã‚µãƒãƒ¼ãƒˆ
      const japaneseSupport = generateJapaneseSupport(result);
      support.textContent = japaneseSupport;

      // å±¥æ­´ä¿å­˜
      // å±¥æ­´ä¿å­˜ã¯å¾Œã§å®Ÿè£…

      status.textContent = "ã‚ˆãã§ããŸã­ï¼ã¾ãŸè©±ã—ãŸããªã£ãŸã‚‰æŠ¼ã—ã¦ã­";
    };

    recognition.onerror = function (event) {
      console.error("éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:", event.error);
      let errorMessage = "ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã¿ã¦ã­ï¼";

      if (event.error === "no-speech") {
        errorMessage = "å£°ãŒèã“ãˆã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©±ã—ã¦ã¿ã¦";
      } else if (event.error === "network") {
        errorMessage = "ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ã­";
      }

      status.textContent = errorMessage;
      resetRecordButton();
    };

    recognition.onend = function () {
      resetRecordButton();
    };
  } else {
    status.textContent = "ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŸ³å£°èªè­˜ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“";
    recordBtn.disabled = true;
    recordBtn.textContent = "âŒ éå¯¾å¿œ";
  }
}

// éŒ²éŸ³ãƒœã‚¿ãƒ³ãƒªã‚»ãƒƒãƒˆ
function resetRecordButton() {
  isRecording = false;
  recordBtn.textContent = "ğŸ¤ è‹±èªã§è©±ã—ã¦ã¿ã‚ˆã†ï¼";
  recordBtn.classList.remove("recording");
}

// è‹±èªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”Ÿæˆ
function generateEnglishFeedback(text, confidence = 0.8) {
  const encouragements = [
    "Excellent pronunciation! Well done!",
    "Great job! Your English is improving!",
    "Wonderful! Keep up the good work!",
    "Amazing! You spoke clearly!",
    "Fantastic effort! Try another one!",
    "Perfect! Your English sounds great!",
    "Outstanding! Keep practicing!",
    "Brilliant! You're getting better!",
    "Superb! That was very clear!",
    "Marvelous! You're doing so well!",
  ];

  // è‹±èªã‚‰ã—ã„å˜èªãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  const englishWords = [
    "hello",
    "hi",
    "good",
    "morning",
    "afternoon",
    "evening",
    "my",
    "name",
    "is",
    "i",
    "am",
    "like",
    "love",
    "want",
    "thank",
    "you",
    "please",
    "sorry",
    "excuse",
    "me",
    "today",
    "tomorrow",
    "yesterday",
    "how",
    "what",
    "where",
    "when",
    "why",
    "who",
    "can",
    "could",
    "would",
    "should",
  ];

  const hasEnglish = englishWords.some((word) =>
    text.toLowerCase().includes(word)
  );

  if (hasEnglish && confidence > 0.6) {
    return encouragements[Math.floor(Math.random() * encouragements.length)];
  } else if (hasEnglish) {
    return "Good try! Keep practicing your pronunciation!";
  } else {
    return "Nice effort! Remember to speak in English. Try again!";
  }
}

// æ—¥æœ¬èªã‚µãƒãƒ¼ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
function generateJapaneseSupport(text) {
  const supportMessages = [
    "è‹±èªã§è©±ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼",
    "è‹±èªã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ãˆã‚‰ã„ã­ï¼",
    "ã™ã¦ããªè‹±èªã ã£ãŸã‚ˆï¼",
    "è‹±èªã§è©±ã™ã®ã£ã¦æ¥½ã—ã„ã­ï¼",
    "ã¾ãŸè‹±èªã§è©±ã—ã¦ã­ï¼",
    "ã¨ã¦ã‚‚é ‘å¼µã£ãŸã­ï¼ã™ã”ã„ã‚ˆï¼",
    "è‹±èªãŒä¸Šæ‰‹ã«ãªã£ã¦ããŸã­ï¼",
    "ãã®èª¿å­ã§ãŒã‚“ã°ã‚ã†ï¼",
  ];

  return supportMessages[Math.floor(Math.random() * supportMessages.length)];
}

// å±¥æ­´ä¿å­˜ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼‰
function saveToHistory(text, message) {
  const historyData = JSON.parse(localStorage.getItem("budHistory") || "[]");
  const newEntry = {
    timestamp: new Date().toLocaleString("ja-JP"),
    text: text,
    message: message,
    date: new Date().toDateString(),
  };

  historyData.unshift(newEntry); // æ–°ã—ã„ã‚‚ã®ã‚’å…ˆé ­ã«

  // æœ€å¤§20ä»¶ã¾ã§ä¿å­˜
  if (historyData.length > 20) {
    historyData.pop();
  }

  localStorage.setItem("budHistory", JSON.stringify(historyData));
  displayHistory();
}

// å±¥æ­´è¡¨ç¤º
function displayHistory() {
  const historyData = JSON.parse(localStorage.getItem("budHistory") || "[]");

  if (historyData.length === 0) {
    history.innerHTML =
      '<p style="text-align: center; opacity: 0.7;">ã¾ã ç·´ç¿’è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>è‹±èªã§è©±ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>';
    return;
  }

  history.innerHTML = historyData
    .map(
      (entry, index) => `
        <div class="history-item">
            <div class="history-time">${entry.timestamp}</div>
            <div class="history-text">ğŸ’¬ "${entry.text}"</div>
            <div class="history-message">âœ¨ ${entry.message}</div>
        </div>
    `
    )
    .join("");
}

// å±¥æ­´ã‚¯ãƒªã‚¢
function clearHistory() {
  if (confirm("ç·´ç¿’è¨˜éŒ²ã‚’å…¨éƒ¨æ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) {
    localStorage.removeItem("budHistory");
    displayHistory();
    status.textContent = "è¨˜éŒ²ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸï¼æ–°ã—ãå§‹ã‚ã¾ã—ã‚‡ã†";
  }
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
recordBtn.addEventListener("click", function () {
  if (!isRecording && recognition) {
    recognition.start();
  }
});

clearBtn.addEventListener("click", clearHistory);

// åˆæœŸåŒ–
document.addEventListener("DOMContentLoaded", function () {
  initSpeechRecognition();
  displayHistory();

  // åˆå›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  if (!localStorage.getItem("budHistory")) {
    status.textContent = "ã‚ˆã†ã“ãBUDã¸ï¼è‹±èªã§è©±ã—ã¦ã¿ã‚ˆã†ï¼";
  }
});

// PWAç”¨ï¼ˆå°†æ¥ã®æ‹¡å¼µï¼‰
if ("serviceWorker" in navigator) {
  window.addEventListener("load", function () {
    // Service Workerç™»éŒ²ã¯å¾Œã§å®Ÿè£…
  });
}

// ===== Gemini AIæ©Ÿèƒ½è¿½åŠ  =====
const GEMINI_API_KEY = "AIzaSyDXbJlTPGuSlTg40y9SjirjxAvbgkgx4W4";

async function generateAIFeedback(recognizedText) {
  try {
    // ã‚ˆã‚Šè©³ç´°ã§å…·ä½“çš„ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    const prompt = `
ã‚ãªãŸã¯å­ã©ã‚‚å‘ã‘è‹±èªå­¦ç¿’ã®å°‚é–€AIå…ˆç”Ÿã§ã™ã€‚

å­ã©ã‚‚ãŒè‹±èªã§ã€Œ${recognizedText}ã€ã¨è©±ã—ã¾ã—ãŸã€‚

ä»¥ä¸‹ã®è¦ç´ ã‚’å«ã‚€30-50æ–‡å­—ã®åŠ±ã¾ã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ—¥æœ¬èªã§ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š

1. å…·ä½“çš„ã«è‰¯ã‹ã£ãŸç‚¹ã‚’1ã¤è¤’ã‚ã‚‹
2. ç°¡å˜ãªæ”¹å–„ææ¡ˆï¼ˆã‚ã‚Œã°ï¼‰
3. æ¸©ã‹ã„åŠ±ã¾ã—ã®è¨€è‘‰

ä¾‹ï¼š
- ã€ŒHelloã€â†’ã€Œã¯ã£ãã‚Šã—ãŸç™ºéŸ³ã§ãˆã‚‰ã„ã­ï¼æ¬¡ã¯'How are you?'ã‚‚è¨€ã£ã¦ã¿ã‚ˆã†ï¼ã€
- ã€ŒMy name is Tomã€â†’ã€Œè‡ªå·±ç´¹ä»‹ãŒå®Œç’§ï¼nameã®ç™ºéŸ³ãŒã¨ã¦ã‚‚ãã‚Œã„ã§ã—ãŸï¼ã€
- ã€ŒI like appleã€â†’ã€Œå¥½ããªã‚‚ã®ã‚’è‹±èªã§è¨€ãˆãŸã­ï¼appleã®'a'ã®éŸ³ãŒã¨ã¦ã‚‚ä¸Šæ‰‹ï¼ã€

è©±ã—ãŸå†…å®¹: "${recognizedText}"
æ–‡å­—æ•°: 30-50æ–‡å­—
å£èª¿: æ˜ã‚‹ãæ¸©ã‹ã„å…ˆç”Ÿ
`;

    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`,
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          contents: [
            {
              parts: [
                {
                  text: prompt,
                },
              ],
            },
          ],
          generationConfig: {
            temperature: 0.8, // å‰µé€ æ€§ã‚’ä¸Šã’ã‚‹
            topK: 40,
            topP: 0.9,
            maxOutputTokens: 100,
          },
        }),
      }
    );

    const data = await response.json();

    if (data.candidates && data.candidates[0] && data.candidates[0].content) {
      let feedback = data.candidates[0].content.parts[0].text;

      // ä¸è¦ãªæ–‡å­—ã‚’é™¤å»
      feedback = feedback.replace(/[ã€Œã€ã€ã€]/g, '"').trim();

      return feedback;
    } else {
      throw new Error("Gemini API response invalid");
    }
  } catch (error) {
    console.error("Gemini API Error:", error);

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®å¤šæ§˜ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const fallbackMessages = [
      `ã€Œ${recognizedText}ã€ã£ã¦è¨€ãˆãŸã­ï¼ç™ºéŸ³ãŒã¨ã¦ã‚‚ãã‚Œã„ï¼`,
      `è‹±èªã§è©±ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼ã€Œ${recognizedText}ã€å®Œç’§ã ã‚ˆï¼`,
      `ã™ã”ã„ï¼ã€Œ${recognizedText}ã€ã®ç™ºéŸ³ãŒã¨ã¦ã‚‚ä¸Šæ‰‹ã§ã—ãŸï¼`,
      `ã€Œ${recognizedText}ã€ã‚’ã¯ã£ãã‚Šè¨€ãˆã¦ãˆã‚‰ã„ã­ï¼æ¬¡ã‚‚ãŒã‚“ã°ã‚ã†ï¼`,
      `è‹±èªãƒãƒ£ãƒ¬ãƒ³ã‚¸æˆåŠŸï¼ã€Œ${recognizedText}ã€ã®è¨€ã„æ–¹ãƒãƒƒãƒãƒªï¼`,
    ];

    return fallbackMessages[
      Math.floor(Math.random() * fallbackMessages.length)
    ];
  }
}
